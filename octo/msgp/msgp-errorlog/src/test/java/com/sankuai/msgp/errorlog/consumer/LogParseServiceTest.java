package com.sankuai.msgp.errorlog.consumer;

import com.sankuai.msgp.common.model.errorlog.ParsedLog;
import com.sankuai.msgp.common.utils.DateTimeUtil;
import com.sankuai.msgp.common.utils.helper.JsonHelper;
import com.sankuai.msgp.errorlog.ApplicationTest;
import com.sankuai.msgp.errorlog.service.LogParseService;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import java.io.IOException;
import java.util.*;

@RunWith(SpringJUnit4ClassRunner.class)
public class LogParseServiceTest extends ApplicationTest {

    @Autowired
    private LogParseService logParseService;

    /**
     * 业务反馈报警有问题时测试
     * @throws Exception
     */
    @Test
    public void testLogConsume() throws Exception {
        String log = "{\"location\":\"com.dianping.mobile.framework.util.TokenUtil\",\"message\":\"getMtIdByDpUserId ex, userId:36153846, msg:mtthrift remote(10.32.248.210:6489) invoke(getMtVirtualUserIdByDpUserid) timeout, traceId:-673571154681390155, timeout:100\",\"exception\":\"\",\"host\":\"mapi-usercenter-web04.yp\",\"appkey\":\"com.sankuai.inf.octo.errorlog.mock\",\"uniqueKey\":\"com.sankuai.inf.octo.errorlog.mock_6397e812-6f09-4023-83ff-f154274f46eb\",\"logTime\":\"%s\",\"exceptionName\":\"\",\"traceId\":\"\",\"thresholdMin\":null,\"filterId\":null}\n";
        Date date = new Date();
        String message_tmp = String.format(log, date.getTime());
        Thread.sleep(100L);
        logParseService.handleMessage(message_tmp);
    }

    @Test
    public void consumeMessage() throws Exception {
        String message = "{\"rowkey\":\"com.sankuai.inf.octo.errorlog.mock_%s_8ee5efaa-88bb-49cf-a1b1-a01f58e013ab\",\"level\":\"ERROR\",\"appkey\":\"com.sankuai.inf.octo.errorlog.mock\",\"host\":\"set-gh-inf-octo-errorlog-mock01.gh.sankuai.com\",\"ip\":\"unknown\",\"location\":\"com.sankuai.octo.errorlog.mock.Bootstrap\",\"action\":null,\"rawLog\":\"Error log auto-generated by mock service. time:  %s\",\"logTime\":\"%s\",\"rawException\":\"\",\"traceId\":\"\",\"exceptionName\":\"\"}";
        for (int i = 0; i < 2000; i++) {
            Date date = new Date();
            String time = DateTimeUtil.format(date, "yyyy-MM-dd HH:mm:ss");
            String message_tmp = String.format(message, time, time, time);
            Thread.sleep(100L);
            logParseService.handleMessage(message_tmp);
        }
        Thread.sleep(6000l);
    }

    @Test
    public void consumeMessageNew() throws InterruptedException, IOException {
        String log = "{\"location\":\"com.dianping.mobile.framework.util.TokenUtil\",\"message\":\"validate newtoken failed[331d6f6da585805b1acaae1d4e1a719b9fd6e3de9a9a56738ae0982ff8d19178][331d6f6da585805b1acaae1d4e1a719b9fd6e3de9a9a56738ae0982ff8d19178][0][3]\\n\",\"exception\":\"\",\"host\":\"mapi-usercenter-web04.yp\",\"appkey\":\"com.sankuai.inf.octo.errorlog.mock\",\"uniqueKey\":\"com.sankuai.inf.octo.errorlog.mock_6397e812-6f09-4023-83ff-f154274f46eb\",\"logTime\":\"%s\",\"exceptionName\":\"\",\"traceId\":\"\",\"thresholdMin\":null,\"filterId\":null}\n";
        for (int i = 0; i < 10; i++) {
            Date date = new Date();
            String message_tmp = String.format(log, date.getTime());
            Thread.sleep(100L);
            logParseService.handleMessage(message_tmp);
        }
        Thread.sleep(6000l);
    }

    /**
     * 测试Json字符串转pojo性能
     */
    private Set<String> appkeys = new HashSet();

    @Test
    public void testLogParse() {
        initAppkeySet();
        String exceptionMsg = "org.apache.thrift.TException: mtthrift remote(10.32.82.114:8600) invoke(getPoiReplyCount) timeout, traceId:5141487143270596720, timeout:300<br/><br/>at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.wrapException(MTThriftMethodInterceptor.java:515)<br/><br/>at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.syncRpcInvoke(MTThriftMethodInterceptor.java:361)<br/><br/>at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.getRpcResult(MTThriftMethodInterceptor.java:254)<br/><br/>at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.invoke(MTThriftMethodInterceptor.java:188)<br/><br/>at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)<br/><br/>at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:213)<br/><br/>at com.sun.proxy.$Proxy94.getPoiReplyCount(Unknown Source)<br/><br/>at com.sankuai.meituan.waimai.service.impl.CUGCThriftServiceProxy.getComment_reply_count(CUGCThriftServiceProxy.java:555)<br/><br/>at sun.reflect.GeneratedMethodAccessor1384.invoke(Unknown Source)<br/><br/>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br/><br/>at java.lang.reflect.Method.invoke(Method.java:606)<br/><br/>at com.netflix.hystrix.contrib.javanica.command.MethodExecutionAction.execute(MethodExecutionAction.java:116)<br/><br/>at com.netflix.hystrix.contrib.javanica.command.MethodExecutionAction.executeWithArgs(MethodExecutionAction.java:93)<br/><br/>at com.netflix.hystrix.contrib.javanica.command.MethodExecutionAction.execute(MethodExecutionAction.java:78)<br/><br/>at com.netflix.hystrix.contrib.javanica.command.GenericCommand$1.execute(GenericCommand.java:47)<br/><br/>at com.netflix.hystrix.contrib.javanica.command.AbstractHystrixCommand.process(AbstractHystrixCommand.java:145)<br/><br/>at com.netflix.hystrix.contrib.javanica.command.GenericCommand.run(GenericCommand.java:44)<br/><br/>at com.netflix.hystrix.HystrixCommand$2.call(HystrixCommand.java:301)<br/><br/>at com.netflix.hystrix.HystrixCommand$2.call(HystrixCommand.java:297)<br/><br/>at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:46)<br/><br/>at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35)<br/><br/>at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)<br/><br/>at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)<br/><br/>at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)<br/><br/>at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)<br/><br/>at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)<br/><br/>at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)<br/><br/>at rx.Observable.unsafeSubscribe(Observable.java:10211)<br/><br/>at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:51)<br/><br/>at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35)<br/><br/>at rx.Observable.unsafeSubscribe(Observable.java:10211)<br/><br/>at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)<br/><br/>at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)<br/><br/>at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)<br/><br/>at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)<br/><br/>at rx.Observable.unsafeSubscribe(Observable.java:10211)<br/><br/>at rx.internal.operators.OperatorSubscribeOn$1.call(OperatorSubscribeOn.java:94)<br/><br/>at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction$1.call(HystrixContexSchedulerAction.java:56)<br/><br/>at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction$1.call(HystrixContexSchedulerAction.java:47)<br/><br/>at com.meituan.mtrace.thread.TraceCallable.call(TraceCallable.java:33)<br/><br/>at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction.call(HystrixContexSchedulerAction.java:69)<br/><br/>at rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:55)<br/><br/>at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)<br/><br/>at java.util.concurrent.FutureTask.run(FutureTask.java:262)<br/><br/>at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)<br/><br/>at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)<br/><br/>at com.meituan.mtrace.thread.TraceRunnable.run(TraceRunnable.java:32)<br/><br/>at java.lang.Thread.run(Thread.java:745)<br/>Caused by: org.apache.thrift.transport.TTransportException: java.net.SocketTimeoutException: Read timed out<br/><br/>at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:129)<br/><br/>at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)<br/><br/>at com.meituan.service.mobile.mtthrift.transport.CustomizedTFramedTransport.readFrame(CustomizedTFramedTransport.java:239)<br/><br/>at com.meituan.service.mobile.mtthrift.transport.CustomizedTFramedTransport.read(CustomizedTFramedTransport.java:189)<br/><br/>at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)<br/><br/>at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:378)<br/><br/>at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:297)<br/><br/>at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:204)<br/><br/>at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:69)<br/><br/>at com.sankuai.meituan.waimai.service.ugc.iface.v1.WmCommentThriftService$Client.recv_getPoiReplyCount(WmCommentThriftService.java:1033)<br/><br/>at com.sankuai.meituan.waimai.service.ugc.iface.v1.WmCommentThriftService$Client.getPoiReplyCount(WmCommentThriftService.java:1020)<br/><br/>at sun.reflect.GeneratedMethodAccessor1385.invoke(Unknown Source)<br/><br/>at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br/><br/>at java.lang.reflect.Method.invoke(Method.java:606)<br/><br/>at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.syncRpcInvoke(MTThriftMethodInterceptor.java:318)<br/><br/>... 46 more<br/>Caused by: java.net.SocketTimeoutException: Read timed out<br/><br/>at java.net.SocketInputStream.socketRead0(Native Method)<br/><br/>at java.net.SocketInputStream.read(SocketInputStream.java:152)<br/><br/>at java.net.SocketInputStream.read(SocketInputStream.java:122)<br/><br/>at java.io.BufferedInputStream.fill(BufferedInputStream.java:235)<br/><br/>at java.io.BufferedInputStream.read1(BufferedInputStream.java:275)<br/><br/>at java.io.BufferedInputStream.read(BufferedInputStream.java:334)<br/><br/>at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:127)<br/><br/>... 60 more<br/>org.apache.thrift.TException: mtthrift remote(10.32.82.114:8600) invoke(getPoiReplyCount) timeout, traceId:5141487143270596720, timeout:300at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.wrapException(MTThriftMethodInterceptor.java:515) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.syncRpcInvoke(MTThriftMethodInterceptor.java:361) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.getRpcResult(MTThriftMethodInterceptor.java:254) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.invoke(MTThriftMethodInterceptor.java:188) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179) ~[spring-aop-4.3.4.RELEASE.jar:4.3.4.RELEASE]at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:213) ~[spring-aop-4.3.4.RELEASE.jar:4.3.4.RELEASE]at com.sun.proxy.$Proxy94.getPoiReplyCount(Unknown Source) ~[?:?]at com.sankuai.meituan.waimai.service.impl.CUGCThriftServiceProxy.getComment_reply_count(CUGCThriftServiceProxy.java:555) ~[waimai_api_common-1.0.155-prod-SNAPSHOT.jar:?]at sun.reflect.GeneratedMethodAccessor1384.invoke(Unknown Source) ~[?:?]at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.7.0_76]at java.lang.reflect.Method.invoke(Method.java:606) ~[?:1.7.0_76]at com.netflix.hystrix.contrib.javanica.command.MethodExecutionAction.execute(MethodExecutionAction.java:116) ~[hystrix-javanica-1.5.6.jar:1.5.6]at com.netflix.hystrix.contrib.javanica.command.MethodExecutionAction.executeWithArgs(MethodExecutionAction.java:93) ~[hystrix-javanica-1.5.6.jar:1.5.6]at com.netflix.hystrix.contrib.javanica.command.MethodExecutionAction.execute(MethodExecutionAction.java:78) ~[hystrix-javanica-1.5.6.jar:1.5.6]at com.netflix.hystrix.contrib.javanica.command.GenericCommand$1.execute(GenericCommand.java:47) ~[hystrix-javanica-1.5.6.jar:1.5.6]at com.netflix.hystrix.contrib.javanica.command.AbstractHystrixCommand.process(AbstractHystrixCommand.java:145) ~[hystrix-javanica-1.5.6.jar:1.5.6]at com.netflix.hystrix.contrib.javanica.command.GenericCommand.run(GenericCommand.java:44) ~[hystrix-javanica-1.5.6.jar:1.5.6]at com.netflix.hystrix.HystrixCommand$2.call(HystrixCommand.java:301) ~[hystrix-core-1.5.6.jar:1.5.6]at com.netflix.hystrix.HystrixCommand$2.call(HystrixCommand.java:297) ~[hystrix-core-1.5.6.jar:1.5.6]at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:46) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30) ~[rxjava-1.1.10.jar:1.1.10]at rx.Observable.unsafeSubscribe(Observable.java:10211) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:51) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35) ~[rxjava-1.1.10.jar:1.1.10]at rx.Observable.unsafeSubscribe(Observable.java:10211) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30) ~[rxjava-1.1.10.jar:1.1.10]at rx.Observable.unsafeSubscribe(Observable.java:10211) ~[rxjava-1.1.10.jar:1.1.10]at rx.internal.operators.OperatorSubscribeOn$1.call(OperatorSubscribeOn.java:94) ~[rxjava-1.1.10.jar:1.1.10]at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction$1.call(HystrixContexSchedulerAction.java:56) ~[hystrix-core-1.5.6.jar:1.5.6]at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction$1.call(HystrixContexSchedulerAction.java:47) ~[hystrix-core-1.5.6.jar:1.5.6]at com.meituan.mtrace.thread.TraceCallable.call(TraceCallable.java:33) ~[mtrace-api-1.1.6.jar:?]at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction.call(HystrixContexSchedulerAction.java:69) ~[hystrix-core-1.5.6.jar:1.5.6]at rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:55) ~[rxjava-1.1.10.jar:1.1.10]at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[?:1.7.0_76]at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[?:1.7.0_76]at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [?:1.7.0_76]at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [?:1.7.0_76]at com.meituan.mtrace.thread.TraceRunnable.run(TraceRunnable.java:32) ~[mtrace-api-1.1.6.jar:?]at java.lang.Thread.run(Thread.java:745) [?:1.7.0_76]Caused by: org.apache.thrift.transport.TTransportException: java.net.SocketTimeoutException: Read timed outat org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:129) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84) ~[libthrift-0.8.0.jar:0.8.0]at com.meituan.service.mobile.mtthrift.transport.CustomizedTFramedTransport.readFrame(CustomizedTFramedTransport.java:239) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]at com.meituan.service.mobile.mtthrift.transport.CustomizedTFramedTransport.read(CustomizedTFramedTransport.java:189) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:378) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:297) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:204) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:69) ~[libthrift-0.8.0.jar:0.8.0]at com.sankuai.meituan.waimai.service.ugc.iface.v1.WmCommentThriftService$Client.recv_getPoiReplyCount(WmCommentThriftService.java:1033) ~[waimai_service_ugc_client-1.3.0-20170828.114449-4.jar:1.3.0-SNAPSHOT]at com.sankuai.meituan.waimai.service.ugc.iface.v1.WmCommentThriftService$Client.getPoiReplyCount(WmCommentThriftService.java:1020) ~[waimai_service_ugc_client-1.3.0-20170828.114449-4.jar:1.3.0-SNAPSHOT]at sun.reflect.GeneratedMethodAccessor1385.invoke(Unknown Source) ~[?:?]at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.7.0_76]at java.lang.reflect.Method.invoke(Method.java:606) ~[?:1.7.0_76]at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.syncRpcInvoke(MTThriftMethodInterceptor.java:318) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]... 46 moreCaused by: java.net.SocketTimeoutException: Read timed outat java.net.SocketInputStream.socketRead0(Native Method) ~[?:1.7.0_76]at java.net.SocketInputStream.read(SocketInputStream.java:152) ~[?:1.7.0_76]at java.net.SocketInputStream.read(SocketInputStream.java:122) ~[?:1.7.0_76]at java.io.BufferedInputStream.fill(BufferedInputStream.java:235) ~[?:1.7.0_76]at java.io.BufferedInputStream.read1(BufferedInputStream.java:275) ~[?:1.7.0_76]at java.io.BufferedInputStream.read(BufferedInputStream.java:334) ~[?:1.7.0_76]at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:127) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84) ~[libthrift-0.8.0.jar:0.8.0]at com.meituan.service.mobile.mtthrift.transport.CustomizedTFramedTransport.readFrame(CustomizedTFramedTransport.java:239) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]at com.meituan.service.mobile.mtthrift.transport.CustomizedTFramedTransport.read(CustomizedTFramedTransport.java:189) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:378) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:297) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:204) ~[libthrift-0.8.0.jar:0.8.0]at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:69) ~[libthrift-0.8.0.jar:0.8.0]at com.sankuai.meituan.waimai.service.ugc.iface.v1.WmCommentThriftService$Client.recv_getPoiReplyCount(WmCommentThriftService.java:1033) ~[waimai_service_ugc_client-1.3.0-20170828.114449-4.jar:1.3.0-SNAPSHOT]at com.sankuai.meituan.waimai.service.ugc.iface.v1.WmCommentThriftService$Client.getPoiReplyCount(WmCommentThriftService.java:1020) ~[waimai_service_ugc_client-1.3.0-20170828.114449-4.jar:1.3.0-SNAPSHOT]at sun.reflect.GeneratedMethodAccessor1385.invoke(Unknown Source) ~[?:?]at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.7.0_76]at java.lang.reflect.Method.invoke(Method.java:606) ~[?:1.7.0_76]at com.meituan.service.mobile.mtthrift.client.invoker.MTThriftMethodInterceptor.syncRpcInvoke(MTThriftMethodInterceptor.java:318) ~[mtthrift-1.8.4-20170801.103134-1.jar:1.8.4-SNAPSHOT]... 46 more";
        String errorLog = "{\"uniqueKey\":\"com.sankuai.inf.octo.errorlog.mock_1504369000000_8ee5efaa-88bb-49cf-a1b1-a01f58e013ab\",\"level\":\"ERROR\",\"appkey\":\"com.sankuai.inf.octo.errorlog.mock\",\"host\":\"set-gh-inf-octo-errorlog-mock01.gh.sankuai.com\",\"ip\":\"unknown\",\"location\":\"com.sankuai.octo.errorlog.mock.Bootstrap\",\"action\":null,\"message\":\"Error log auto-generated by mock service. time: 1504369000000\",\"logTime\":\"1504369000000\",\"exception\":\"%s\",\"traceId\":\"\",\"exceptionName\":\"\"}";
        errorLog = String.format(errorLog, exceptionMsg);

        long start = System.currentTimeMillis();
        for (int i = 0; i < 120000; i++) {
            ParsedLog log = messageToParsedLog(errorLog);
        }
        long end = System.currentTimeMillis();
        System.out.println("耗时：" + (end - start) / 1000);

    }

    public ParsedLog messageToParsedLog(String error) {
        ParsedLog record = JsonHelper.toObject(error, ParsedLog.class);
        if (record.getLogTime().getTime() > System.currentTimeMillis()) {
            record.setLogTime(new Date());
        }

        if (null == record || !filterAppkey(record.getAppkey())) {
            return null;
        }
        return record;
    }

    private boolean filterAppkey(String appkey) {
        if (appkeys.contains(appkey)) {
            return true;
        }
        return false;
    }

    private void initAppkeySet() {
        String appkeyStrs = "com.sankuai.inf.octo.errorlog.mock,mkt-budget-mq-service,com.sankuai.bb.op.crm,shopdiy-config-service,com.sankuai.ia.search.sieve,overseas-operateadmin-web,com.sankuai.sjst.m.territory,com.sankuai.sjst.erp.data,travel-armweb,slt-mpi-service,com.sankuai.meishi.finance.tradequery,sms-rtmonitor-web,com.sankuai.xm.mbox.media,com.sankuai.meishi.finance.tradecron,m-medicine-web,joy-order-dp-service,com.sankuai.it.oa.doc,com.sankuai.web.luffy.merchantop,com.sankuai.pay.bankgw.pingancredit,com.sankuai.mall.pms.api,mtarm-core,ts-tg-activity-service,ts-distribution-service,com.sankuai.resv.b.stock,poseidon-service,com.sankuai.pay.bankgw.tenpay,com.sankuai.hotel.biz.datacenter.st,merchant-easylife-web,mtarm-web,emidas-union-web,com.sankuai.meishi.merchant.promotion,cip-sku-tailor-service,com.sankuai.mall.datamall.datamall,account-admin-service,waimai_c_activity_admin,com.sankuai.sjst.erp.crmdeal,cip-iconrec-service,com.sankuai.train.train.insurancebasedata,com.sankuai.waimai.m.bizaggr,com.sankuai.pay.bankgw.ccbcredit,shopdiy-cpc-service,com.sankuai.banma.franchisee.data,com.sankuai.hotel.goods.oresundservershanghai,zhaopin-remote-service,com.sankuai.bb.cx.mall.gtapi,com.sankuai.waimai.d.ocr,com.sankuai.banma.package.callback,cip-dimension-center-web,com.sankuai.conch.certify.certifygateway,com.sankuai.waimai.d.search.query,com.sankuai.qcs.service.dispatch,zhaopin-resume-service,joy-job-service,com.sankuai.inf.octo.errorlog,com.sankuai.web.campaign.orderconsumer,com.sankuai.waimai.e.openjob,com.sankuai.qcs.api.growth,kaeru-yuqing-service,com.sankuai.sjst.erp.config,com.sankuai.waimai.e.bizadpub,com.sankuai.lvyou.meilv.virgo,com.sankuai.movie.apollo.opt,com.sankuai.meishi.scp.datacenter,com.sankuai.resv.b.web,deal-refund-service,com.sankuai.banma.finance.account,com.sankuai.zc.cos.crm,com.sankuai.sjst.erp.print,com.sankuai.waimai.d.suggest,com.sankuai.hotel.biz.billc,com.sankuai.resv.c.order,com.sankuai.sjst.erp.cepjob,com.sankuai.pay.fundstransfer.scheduling,sharkpush-service,com.sankuai.it.bsi.mtorgreceiver,com.sankuai.zc.pos.billcheck,com.sankuai.pay.bankgw.cup,com.sankuai.sjst.erp.crmdock,com.sankuai.banma.platform.haikui,com.sankuai.waimai.d.foodserver,com.sankuai.sjst.openplatform.openapi,com.sankuai.pay.bankgw.wxpaynotify,com.sankuai.hbdata.hotelsearch.tag,com.sankuai.banma.api.malladmin,com.sankuai.zc.open.qrcodecomment,vc-meituan-api,com.sankuai.trip.data.platform,com.sankuai.meishi.merchant.permission,com.sankuai.banma.finance.price,flower-web,com.sankuai.pay.paycashier.apihello,com.sankuai.pay.bankgw.alipay,com.sankuai.conch.certify.certifycenter,com.sankuai.trip.c.cdc,com.sankuai.hotel.ia.workorder,com.sankuai.web.deal.dealstockwrite,com.sankuai.xm.mbox.msgapi,com.sankuai.banma.package.sync,com.sankuai.travel.osg.pandoraworkbench,com.sankuai.conch.trade.messagecenter,dpdz-usercenter-service,com.sankuai.lvyou.libra,com.sankuai.dataapp.search.dztips,roc-rotate-app-web,com.sankuai.zc.pos.cloudpay,com.sankuai.meishi.merchant.service,com.sankuai.cos.groupbd,com.sankuai.train.trade.kit,com.sankuai.waimai.m.poiapi,com.sankuai.nlpml.app.clicklocstore,zhaopin-storage-web,com.sankuai.meishi.merchant.dish,shopping-web,com.sankuai.web.deal.dpdealsearch,com.sankuai.travel.dsg.mscvcc,com.sankuai.trip.trade.search,com.sankuai.web.order.consumer,com.sankuai.waimai.d.hongbao,joy-order-service,com.sankuai.waimai.e.bizdataopen,com.sankuai.sjst.openplatform.waimai,hui-scheme-service,com.sankuai.rc.tatooine,com.sankuai.pay.fundstransfer.paycore,com.sankuai.meishi.merchant.ordercenter,com.sankuai.tp.c.orderserver,com.sankuai.web.order.refundqueryproxy,com.sankuai.waimai.m.crmwhale,ba-csc-web,com.sankuai.wmarch.map.facade.client,hui-activity-service,search-tohome-service,com.sankuai.waimai.m.moneyjob,deal-transfer-worker-service,com.sankuai.banma.operation.tos,com.sankuai.hotel.cbs.pegasus,csc-haiyan-service,com.sankuai.zc.open.api.cqrcode,com.sankuai.banma.api.paotui,com.sankuai.waimai.developer,flower-service,com.meituan.hbdata.rec,banma_service_monitor_server,deal-mtnavi-service,com.sankuai.waimai.risk.user,poseidon-product-service,com.sankuai.flight.api.homepage,com.sankuai.xm.xmnew.pub,com.sankuai.pay.userproduct.paytrigger,com.sankuai.hotel.biz.staging,com.sankuai.waimai.d.horseracing,com.sankuai.banma.staff.sqs,com.sankuai.zc.open.baseqrcode,overseas-openplatform-service,com.sankuai.hotel.bizapp,mapi-mtusercenter-web,com.sankuai.hotel.oresund,com.sankuai.cx.quickpass.trade,com.sankuai.banma.operation.attendance,com.sankuai.xm.mbp.emsthrift,com.sankuai.flight.biz.jiutian,com.sankuai.flight.tradeplat.matchservice,com.sankuai.wpt.groupapi.citylist,merchant-mobile-web,com.sankuai.waimai.d.rankjob,com.sankuai.inf.kms.name,com.sankuai.flight.api.apitrade,com.sankuai.waimai.d.drunr,com.sankuai.pay.bankgw.payroute,waimai_service_third_server,waimai_c_yunying_admin,com.sankuai.web.poi.dpshapi,com.sankuai.trip.trade.center,shopdiy-account-web,com.sankuai.cx.quickpass.bankgate,com.sankuai.xm.xmnew.oauthsecondauthorize,com.sankuai.hotel.fe.train,bonus-rule-service,com.sankuai.pay.bankgw.cupshdebit,education-business-web,com.sankuai.pay.userproduct.paymcard,com.sankuai.trip.tradeplatform.tradecenter,com.meituan.movie.pluto,com.sankuai.data.uss,com.sankuai.inf.kms.pay.name,com.sankuai.travel.osg.topsieve.online,com.sankuai.cx.quickpass.apiqr,com.sankuai.zc.pos.openmarket,poseidon-ota-service,com.sankuai.waimai.m.moneybill,com.sankuai.inf.data.statistic,com.sankuai.zc.pos.poscouponfront,com.sankuai.rc.tatooine.event.groupb,com.sankuai.hbdata.hotelsearch.summary,takeaway-mobile-web,ts-account-service,com.sankuai.hotel.cbs.pegasusapi,com.sankuai.web.receipt.consume,com.sankuai.travel.pandora.ruleengine,com.sankuai.waimai.d.cpcctr,banma_api,account-inner-service,com.sankuai.flight.api.booking,com.sankuai.inf.mnsc,hotel-poi-service,com.sankuai.waimai.c.cbaser,takeaway-eventbase-service,com.sankuai.travel.dsg.judge\n" +
                "10.20.216.167:ts-tg-settle-service,com.sankuai.ia.order.api,gm-marketing-micro-tool-service,com.sankuai.flight.biz.flagshipbusiness,com.sankuai.waimai.m.wdcpoiactionflow,zhaopin-campus-web,com.sankuai.movie.oceanus.httpadapter,com.sankuai.waimai.e.bizdatamanager,slt-record-service,baymax-adsync-service,cip-growth-mana-mq,com.sankuai.tmc.rules,overseas-poi-gateway-service,m-pet-web,cip-river-sand-service,com.sankuai.dataapp.recsys.recapirecommend,com.sankuai.banma.operation.voiceassist,com.sankuai.mall.managerapi.productapi,com.sankuai.cos.mtdiscount,com.sankuai.travel.dsg.mscfunds,mkt-event-service,com.sankuai.zc.cos.scp,com.sankuai.sjst.ecom.epassportweb,com.sankuai.flight.biz.ordercenterdatatransfer,com.sankuai.trip.m.tagcenter,com.sankuai.meilv.rivergate,com.sankuai.pay.bankgw.operation,adunion-analysis-web,com.sankuai.pay.paytrade.bill,com.sankuai.ia.order.pay,com.sankuai.waimai.productquery,com.sankuai.rc.tatooine.fallback,com.sankuai.hbdata.spider.check,com.sankuai.zc.cos.bankaccount,com.sankuai.web.activity.luckydog,com.sankuai.meishi.scp.mtsettle,waimai_admin,com.sankuai.hotel.fe.incc,cip-push-based-recommend-mq,com.sankuai.it.oa.avatar,com.sankuai.meishi.scp.discountservice,com.sankuai.zc.pos.asynctask,com.sankuai.sjst.erp.admin,refund-platform-engine-service,aop-activity-container-service,joy-bi-web,com.sankuai.sjst.erp.menu,dp-merchant-activity-c-web,com.sankuai.xm.mbp.emscommon,com.sankuai.movie.merchandise.logistics,joy-user-service,com.sankuai.web.deal.dealprice,com.sankuai.travel.dsg.crmdata,com.sankuai.mall.wms.api,com.sankuai.trip.c.kidsapi,csc-online-robot-service,baymax-adinfo-service,com.sankuai.pay.userproduct.paylife,sku-service-job,com.sankuai.mall.order.order,wedding-chats-server,com.sankuai.data.galaxy.server,com.sankuai.sjst.erp.platformapi,com.sankuai.banma.business.playback,verify-center-service,dp-merchant-ask-web,com.sankuai.trip.tdc.rimet,com.sankuai.meishi.crm.ms,com.sankuai.banma.business.polygon,com.sankuai.travel.dsg.tripext,com.sankuai.trip.c.quoraantispam,com.sankuai.it.oa.kaoqin,com.sankuai.pay.userproduct.phonecharge,waimai_m_hummingbird,zhaopin-app-bole-mq,com.sankuai.waimai.promotion,com.sankuai.pay.bankgw.cibcredit,com.sankuai.hotel.biz.datacenterpreonline,poseidon-merhcant-web,com.sankuai.ia.fe.phxwww,com.sankuai.web.deal.dealspecialtype,cip-quality-promotion-service,com.sankuai.travel.dsg.tripextfb,com.sankuai.conch.certify.certifygate,com.sankuai.waimai.e.promotionreuseapi,cip-smart-category-service,com.sankuai.flight.eng.pricecalendar,com.sankuai.waimai.d.dqms,com.sankuai.qcs.service.promotion,rs-receipt-consume-service,com.sankuai.waimai.e.dispatchcore,com.sankuai.travel.osg.topsieve.staging,tp-usercenter-server,com.sankuai.ia.order.capi,midas-campaign-service,com.sankuai.meishi.merchant.account,com.sankuai.waimai.poiaudit,com.sankuai.meishi.data.realtradeimporter,com.sankuai.sjst.openplatform.restaurant,com.sankuai.xm.uinfo,com.sankuai.banma.platform.openapi,com.sankuai.trip.c.jingqutongapi,com.sankuai.waimai.infra,com.sankuai.movie.oceanus.analysis,slt-beijing-receive-web,com.sankuai.pay.bankgw.msbcredit,emidas-activity-web,com.sankuai.web.poi.poirichnesstask,emidas-lottery-web,com.sankuai.waimai.c.msg.processor,hotel-order-web,com.sankuai.trip.c.venusdealsearch,com.sankuai.waimai.kaidian,com.sankuai.data.datalink.luncher,slt-open-service,com.sankuai.trip.tradeplatform.search,mopay-nonmajor-service,com.sankuai.pay.bankgw.cmbcredit,com.sankuai.travel.dsg.budapest,cip-growth-action-scanshop-mq,com.sankuai.waimai.d.baduflavor,joy-mq-service,com.sankuai.wpt.web.pcapi,com.sankuai.banma.franchisee.server,deal-publish-service,com.sankuai.pay.merchantproduct.mcertify,aop-property-mq,gateway-web,com.sankuai.xm.xmnew.msgreader,hotel-revenue-service,com.sankuai.travel.sirius,cip-growth-recengine-service,com.sankuai.web.meishifilter.dailynew,takeaway-eventbusiness-service,dakka-main-service,merchant-qrcode-apollo-app-web,adps-workflow-mq,csc-websocket-data-service,com.sankuai.pay.paycashier.payuseraction,com.sankuai.trip.zhilian.fenxiaohotel,com.sankuai.banma.api.nuwa,mobile.columbus,com.sankuai.web.campaign.journal,com.sankuai.zc.pos.officialaccounts,aop-push-service,friend-reddot-service,com.sankuai.trip.c.quoraapi,baymax-adx-landing-api,joy-event-service,com.sankuai.banma.api.paotuib,overseas-promotion-web,com.sankuai.banma.biz.proxy,banma_monitor_web,com.sankuai.flight.basis.checkin,com.sankuai.waimai.e.marketingtask,com.sankuai.qcs.service.lbstrail,general-data-rec-service,com.sankuai.waimai.m.moneyproc,joy-notify-service,com.sankuai.waimai.e.imcloud,takeaway-activitymapi-web,mapi-mtlist-web,mall-server,waimai_service_c_base_product_server,com.sankuai.meishi.fe.finance,com.sankuai.train.train.coach,com.sankuai.zc.fe.qrcode,vc-communitylife-web,com.sankuai.hotel.oversea.hades,com.meituan.web.msgopt,mapi-mtshop-web,com.sankuai.waimai.open,com.sankuai.pay.bankgw.cupshcredit,banma_service_rider_admin_server,com.sankuai.web.order.paynotifymtw,com.sankuai.waimai.bizauth,csc-online-customer-web,rs-receipt-base-rpc-service,com.sankuai.vip.pay.misapi,com.sankuai.trip.b.triphsserver,com.sankuai.train.train.insurancebackservice,com.sankuai.hotel.biz,com.sankuai.rc.yoda.yoda,com.sankuai.zc.pos.dataconvert,com.sankuai.pay.bankgw.applecup,com.sankuai.cx.quickpass.api,com.sankuai.travel.quark,overseas-promotion-service,waimai_service_c_lbs_server,com.sankuai.flight.basis.losangeles,mobile-account-web,baby-mobile-m-web,com.sankuai.waimai.c.monitorasyncprocess,com.sankuai.qcs.data.crawler,com.sankuai.lvyou.meilv.trade,com.sankuai.web.campaign.assigncard,com.sankuai.wpt.automan.moonwork,hotel-mapi-web,mapi-mttgdetail-web,com.sankuai.waimai.d.elescope,hotel-product-web,com.sankuai.qcs.service.lbs,poseidon-order-service,com.sankuai.movie.maoyan.movieticket,mapi-mtdetail-web,com.sankuai.xm.xmnew.pubread,com.sankuai.hotel.hotelapi.detailpoi";
        List<String> list = Arrays.asList(appkeyStrs.split(","));
        appkeys = new HashSet<>(list);
    }
}
